/*
 * sd_card.c
 *
 *  Created on: Apr 6, 2025
 *      Author: chant
 */
//#include "sd_card.h"
//#include <string.h>
//void save_sd(double airspeed, double calibrated_airspeed, uint16_t raw_pressure) {
//    printf("Airspeed: %.2f, Calibrated Airspeed: %.2f, Raw Pressure: %hu\r\n",
//           airspeed, calibrated_airspeed, raw_pressure);
//    FIL file_obj;           // File object
//    FRESULT result;         // FatFs result code
//    UINT bytes_written;     // Number of bytes written
//    char data_buffer[128];  // Buffer to hold formatted string
//
//    // Get the elapsed time (in milliseconds) since the system started
//    uint32_t tick = HAL_GetTick();
//
//    // Format the tick and data into a CSV formatted string.
//    // Format: tick,airspeed,calibrated_airspeed,raw_pressure
//    snprintf(data_buffer, sizeof(data_buffer),
//             "%lu,%.2f,%.2f,%hu\r\n",
//             tick, airspeed, calibrated_airspeed, raw_pressure);
//
//    // Open the file (create it if it doesn't exist) with write access
//    result = f_open(&file_obj, "airspeed.csv", FA_OPEN_ALWAYS | FA_WRITE);
//    if (result != FR_OK) {
//        // Handle file open error
//        return;
//    }
//
//    // Move the file pointer to the end of the file so that we append new data
//    result = f_lseek(&file_obj, f_size(&file_obj));
//    if (result != FR_OK) {
//        f_close(&file_obj);
//        return;
//    }
//
//    // Write the formatted string to the file
//    result = f_write(&file_obj, data_buffer, strlen(data_buffer), &bytes_written);
//    if (result != FR_OK) {
//        // Handle write error and close file
//        f_close(&file_obj);
//        return;
//    }
//
//    // Close the file to ensure data is saved properly
//    f_close(&file_obj);
//}
#include "sd_card.h"
#include <stdio.h>
#include <string.h>
// Make sure to include the header that declares dtostrf, if it is not already declared
// For some environments, you may need to declare it yourself:
// char *dtostrf(double __val, signed char __width, unsigned char __prec, char *__s);

void save_sd(double airspeed, double calibrated_airspeed, uint16_t raw_pressure) {
    FIL file_obj;           // File object
    FRESULT result;         // FatFs result code
    UINT bytes_written;     // Number of bytes written
    char data_buffer[128];  // Buffer to hold formatted string

    // Convert floating point values to strings
    char airspeed_str[16];
    char calibrated_str[16];
    dtostrf(airspeed, 6, 2, airspeed_str);          // 6 characters wide, 2 digits precision
    dtostrf(calibrated_airspeed, 6, 2, calibrated_str);

    // Get the elapsed time (in milliseconds) since the system started
    uint32_t tick = HAL_GetTick();

    // Format the tick and data into a CSV formatted string.
    // Format: tick,airspeed,calibrated_airspeed,raw_pressure
    snprintf(data_buffer, sizeof(data_buffer),
             "%lu,%s,%s,%hu\r\n",
             tick, airspeed_str, calibrated_str, raw_pressure);

    // Open the file (create it if it doesn't exist) with write access
    result = f_open(&file_obj, "airspeed.csv", FA_OPEN_ALWAYS | FA_WRITE);
    if (result != FR_OK) {
        // Handle file open error
        return;
    }

    // Move the file pointer to the end of the file so that we append new data
    result = f_lseek(&file_obj, f_size(&file_obj));
    if (result != FR_OK) {
        f_close(&file_obj);
        return;
    }

    // Write the formatted string to the file
    result = f_write(&file_obj, data_buffer, strlen(data_buffer), &bytes_written);
    if (result != FR_OK) {
        // Handle write error and close file
        f_close(&file_obj);
        return;
    }

    // Close the file to ensure data is saved properly
    f_close(&file_obj);
}

